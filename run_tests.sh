#!/usr/bin/env bash
set -euo pipefail

### ── НАСТРОЙКА ───────────────────────────────────────────────
export OLLAMA_HOST="http://127.0.0.1:11434"
MODEL="phi3:mini"                                   # базовая модель
OPTS='{"temperature":0,"top_p":1,"num_predict":12}' # 12 токенов хватит любой метке

# health-check
curl -sf "$OLLAMA_HOST/api/tags" >/dev/null  ||
  { echo "❌ Ollama не отвечает ($OLLAMA_HOST)"; exit 1; }
grep -q "$MODEL" <(curl -s "$OLLAMA_HOST/api/tags") ||
  { echo "❌ Модель $MODEL не найдена (ollama pull)"; exit 1; }

### ── ТЕСТОВЫЕ ФРАЗЫ (добавляйте свои) ───────────────────────
tests=(
  "Включи свет" "Зажги лампу" "Свет включить" "Надо осветить комнату" "Активируй подсветку"
  "Выключи свет" "Погаси лампу" "Туши освещение" "Выруби свет в зале" "Прекрати светить"
  "Сделай теплее" "Добавь пару градусов" "Повышаем температуру" "Хочу стало жарче" "Потеплей"
  "Охлади комнату" "Уменьши градусы" "Хочу прохладу" "Сделай холоднее" "Опусти температуру"
  "Включи музыку" "Запусти трек" "Плейлист включить" "Хочу слушать музыку" "Музыку включай"
  "Выключи музыку" "Останови плеер" "Музыка стоп" "Закончи воспроизведение" "Плеер выключи"
  "Раздвинь шторы" "Открой занавески" "Подними жалюзи" "Шторы раздвинь" "Открой окна шторки"
  "Закрой шторы" "Прикрой занавески" "Опусти жалюзи" "Затемни окна" "Закрой оконные шторы"
  "Включи телевизор" "Телевизор вкл" "Запусти ТВ" "ТВ включи" "Начни трансляцию"
  "Выключи телевизор" "Отключи ТВ" "Телевизор выкл" "Закончи трансляцию" "Стоп тв"
  "Запри дверь" "Закрой на ключ" "Блокируй вход" "Заблокируй замок" "Запирай дверь"
  "Открой дверь" "Сними замок" "Разблокируй замок" "Отпреси дверь" "Открой вход"
  "Проверь датчики" "Состояние сенсоров" "Как работают датчики" "Проверка всех сенсоров" "Отчёт по датчикам"
  "Перезапусти сенсоры" "Рестарт датчиков" "Сбрось датчики" "Сброс сенсоров" "Перезагрузи сенсоры"
  "Какой сегодня день?" "Расскажи шутку" "Сколько 2+2?" "Погода на завтра" "Где ближайшее кафе?"
  "Кто президент России?" "Напомни мне сделать чай" "Что нового в мире?" "Как приготовить борщ?" "Какая скорость света?"
)

### ── ФУНКЦИЯ ОДНОГО ПРОГНОЗА ────────────────────────────────
run_test() {
  local phrase="$1"
  local prompt
  prompt=$(sed "s|<ФРАЗА>|$phrase|g" fewshot.txt)      # ← подставляем фразу в few-shot

  local resp
  resp=$(curl -s "$OLLAMA_HOST/api/generate" \
           -H 'Content-Type: application/json' \
           -d "$(jq -nc \
                 --arg model  "$MODEL" \
                 --arg prompt "$prompt" \
                 --argjson opt "$OPTS" \
                 '{model:$model, prompt:$prompt, options:$opt, stream:false}')" )

  local intent
  intent=$(echo "$resp" | jq -r '.response' | head -n1 | tr -d ' \r\n')
  printf "%-30s → %s\n" "$phrase" "$intent"
}

### ── ЗАПУСК ПАРАЛЛЕЛЬНО ЧЕРЕЗ xargs ─────────────────────────
export -f run_test
export MODEL OPTS OLLAMA_HOST
printf '%s\n' "${tests[@]}" \
  | xargs -P4 -n1 -I{} bash -c 'run_test "$@"' _ {}

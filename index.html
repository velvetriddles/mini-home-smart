<!DOCTYPE html><html lang="ru"><meta charset="utf-8">
<body style="font-family:sans-serif;max-width:600px;margin:40px auto;">
  <h2>Smart-Home Intent Tester</h2>
  <div style="display:flex;align-items:center;margin-bottom:10px;">
    <input id="text" style="width:70%" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É‚Ä¶">
    <button id="send" style="margin-left:5px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="mic" style="margin-left:5px;background:#f05;color:white;border:none;padding:5px 10px;border-radius:3px;">üé§ –ì–æ–ª–æ—Å</button>
  </div>
  <div id="status" style="color:#666;font-size:13px;margin-bottom:10px;"></div>
  <pre id="log" style="background:#111;color:#0f0;padding:12px;min-height:200px;overflow:auto;"></pre>

<script>
// 1. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Vosk WebSocket
let socket;
let isListening = false;
let mediaRecorder;
let audioContext;
let processor;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
function log(message) {
  console.log(message);
  const logElem = document.getElementById('log');
  logElem.textContent += message + '\n';
  logElem.scrollTop = logElem.scrollHeight;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
async function classifyText(text) {
  try {
    log(`–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: "${text}"`);
    document.getElementById('status').textContent = '–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è...';
    
    const res = await fetch('http://localhost:8080/classify', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({text})
    });
    const d = await res.json();
    log(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${d.text}  ‚Üí  ${d.intent}`);
    document.getElementById('status').textContent = '';
  } catch(e) {
    console.error(e);
    log(`–û—à–∏–±–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${e.message}`);
    document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: ' + e.message;
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞
document.getElementById('send').onclick = async () => {
  const text = document.getElementById('text').value.trim();
  if(!text) return;
  await classifyText(text);
  document.getElementById('text').value = '';
};

// –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
document.getElementById('mic').onclick = async () => {
  if (isListening) {
    log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏...');
    stopListening();
  } else {
    log('–ó–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏...');
    await startListening();
  }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket –∏ –∑–∞–ø–∏—Å–∏ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
async function startListening() {
  try {
    let silenceTimer;
    
    log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
    document.getElementById('status').textContent = '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...';
    
    // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: {
        channelCount: 1
      }
    });
    
    log('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω');
    document.getElementById('status').textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ...';
    
    // –°–æ–∑–¥–∞–Ω–∏–µ AudioContext –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–≤—É–∫–∞
    const ctx = new (window.AudioContext || window.webkitAudioContext)({
      sampleRate: 16000
    });
    
    audioContext = ctx;
    
    log(`–ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏: ${audioContext.sampleRate} –ì—Ü`);
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∞—É–¥–∏–æ –∏–∑ –ø–æ—Ç–æ–∫–∞
    const source = audioContext.createMediaStreamSource(stream);
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ–¥–∞–Ω–Ω—ã—Ö
    processor = audioContext.createScriptProcessor(4096, 1, 1);
    
    log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏...');
    document.getElementById('status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...';
    
    // –°–æ–∑–¥–∞–Ω–∏–µ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Vosk
    socket = new WebSocket('ws://localhost:2700');
    socket.binaryType = 'arraybuffer';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è Vosk
    socket.onopen = () => {
      log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è Vosk
      socket.send(JSON.stringify({config:{sample_rate:16000}}));
      
      document.getElementById('status').textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
      document.getElementById('mic').textContent = '‚èπ –°—Ç–æ–ø';
      document.getElementById('mic').style.background = '#05f';
      isListening = true;
    };
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ–¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ WebSocket
    processor.onaudioprocess = (e) => {
      const inData = e.inputBuffer.getChannelData(0);
      const pcm16 = new Int16Array(inData.length);
      for(let i=0; i<inData.length; i++) {
        pcm16[i] = Math.max(-1, Math.min(1, inData[i]))*32767;
      }
      if(socket.readyState === 1) socket.send(pcm16.buffer);

      clearTimeout(silenceTimer);
      silenceTimer = setTimeout(stopListening, 4000);  // –µ—Å–ª–∏ 4 —Å —Ç–∏—à–∏–Ω—ã ‚Äî —Å—Ç–æ–ø
    };
    
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É –∏ –∫ –≤—ã—Ö–æ–¥—É
    source.connect(processor);
    processor.connect(audioContext.destination);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    socket.onmessage = (e) => {
      const d = JSON.parse(e.data);

      // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ partial-—ã
      if (d.partial && d.partial.trim() === '') return;

      log(`–û—Ç–≤–µ—Ç: ${e.data}`);

      if (d.text && d.text.trim() !== '') {
          classifyText(d.text.trim());  // —É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–¥–µ
          stopListening();              // <-- –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å
      }
    };
    
    socket.onerror = (error) => {
      console.error('WebSocket Error:', error);
      log(`–û—à–∏–±–∫–∞ WebSocket: ${error}`);
      document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
      stopListening();
    };
    
    socket.onclose = (event) => {
      console.log('WebSocket closed:', event);
      log(`WebSocket –∑–∞–∫—Ä—ã—Ç: –∫–æ–¥=${event.code}, –ø—Ä–∏—á–∏–Ω–∞=${event.reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`);
      document.getElementById('status').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ';
      stopListening();
    };
    
  } catch(e) {
    console.error('Error:', e);
    log(`–û—à–∏–±–∫–∞: ${e.message}`);
    document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ' + e.message;
  }
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
function stopListening() {
  if (socket && socket.readyState === WebSocket.OPEN) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è');
    socket.send(JSON.stringify({"eof":1}));
    socket.close();
  }
  
  if (processor && audioContext) {
    log('–ó–∞–∫—Ä—ã—Ç–∏–µ –∞—É–¥–∏–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞');
    processor.disconnect();
    audioContext.close();
    processor = null;
    audioContext = null;
  }
  
  document.getElementById('status').textContent = '';
  document.getElementById('mic').textContent = 'üé§ –ì–æ–ª–æ—Å';
  document.getElementById('mic').style.background = '#f05';
  isListening = false;
}

// –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞');
</script>
</body></html> 